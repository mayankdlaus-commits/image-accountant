<script>
  // ---- ADD these top-level variables near your other globals:
  let fileHandle = null;         // picker handle (when allowed)
  let opfsFileHandle = null;     // OPFS fallback handle (no dialogs)
  let useOPFS = JSON.parse(localStorage.getItem('ia_use_opfs') || 'false');

  // ---- OPFS helpers (fallback when picker is blocked)
  async function ensureOPFSFile() {
    // Create (or reopen) a persistent Excel file inside the origin’s private FS
    // File name per year keeps it tidy.
    const year = new Date().getFullYear();
    const root = await navigator.storage.getDirectory();          // OPFS root
    // Subfolder (optional)
    const appDir = await root.getDirectoryHandle('image-accountant', { create: true });
    opfsFileHandle = await appDir.getFileHandle(`entries-${year}.xlsx`, { create: true });
    useOPFS = true;
    localStorage.setItem('ia_use_opfs', 'true');
  }

  async function writeOPFS(binaryArrayBuffer) {
    if (!opfsFileHandle) await ensureOPFSFile();
    const ws = await opfsFileHandle.createWritable();
    await ws.write(binaryArrayBuffer);
    await ws.close();
  }

  // ---- Status UI
  function setLinkStatus(){
    const linkStatus = document.getElementById('linkStatus');
    const connectFileBtn = document.getElementById('connectFileBtn');

    const fsSupported = 'showSaveFilePicker' in window;
    const opfsSupported = !!(navigator.storage && navigator.storage.getDirectory);

    if (fileHandle) {
      linkStatus.textContent = 'Linked ✔ (picker)';
      linkStatus.className = 'hint ok';
      connectFileBtn.style.display = '';
      return;
    }
    if (useOPFS && opfsSupported) {
      linkStatus.textContent = 'Linked ✔ (browser storage)';
      linkStatus.className = 'hint ok';
      connectFileBtn.style.display = '';
      return;
    }
    // Neither linked nor OPFS in use
    if (!fsSupported && !opfsSupported) {
      linkStatus.textContent = 'No linking available (will auto-download on save)';
      linkStatus.className = 'hint warn';
      connectFileBtn.style.display = 'none';
    } else {
      linkStatus.textContent = 'No linked file';
      linkStatus.className = 'hint';
      connectFileBtn.style.display = '';
    }
  }

  // ---- Try to link via picker; if blocked, fall back to OPFS
  async function connectLocalFile(){
    const connectFileBtn = document.getElementById('connectFileBtn');
    connectFileBtn.disabled = true;
    try{
      if ('showSaveFilePicker' in window) {
        try {
          fileHandle = await window.showSaveFilePicker({
            suggestedName: 'image-accountant-entries.xlsx',
            types: [{ description:'Excel',
              accept:{'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':['.xlsx']} }]
          });
          useOPFS = false;
          localStorage.setItem('ia_use_opfs', 'false');
          alert('Linked a local Excel with the system picker.');
        } catch (err) {
          // If the picker is blocked or user cancels, fall back to OPFS when possible
          const name = err && (err.name || '');
          const blocked = name === 'SecurityError' || name === 'NotAllowedError';
          const opfsSupported = !!(navigator.storage && navigator.storage.getDirectory);
          if (blocked && opfsSupported) {
            await ensureOPFSFile();
            alert('System picker blocked. Using browser storage (OPFS) instead.');
          } else if (name === 'AbortError') {
            // user cancelled; do nothing
          } else {
            console.error(err);
            alert('Could not link file: ' + (err.message || err));
          }
        }
      } else if (navigator.storage && navigator.storage.getDirectory) {
        await ensureOPFSFile();
        alert('Using browser storage (OPFS).');
      } else {
        alert('Linking not supported in this browser. We will auto-download on each save.');
      }
    } finally {
      connectFileBtn.disabled = false;
      setLinkStatus();
      // Write current table immediately so the file exists
      await updateLinkedFile();
    }
  }

  // ---- Unified writer: prefer picker file; else OPFS; else auto-download
  async function updateLinkedFile(){
    // Build workbook from current entries (reuse your SheetJS logic)
    const wsData = [['Date','Vendor','Category','Amount','Tax'],
      ...entries.map(e => [e.date, e.vendor, e.category, e.amount, e.tax])];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Receipts');
    const wbout = XLSX.write(wb, { type:'array', bookType:'xlsx' });

    try {
      if (fileHandle) {
        const w = await fileHandle.createWritable();
        await w.write(wbout);
        await w.close();
        return;
      }
      if (useOPFS && navigator.storage && navigator.storage.getDirectory) {
        await writeOPFS(wbout);
        return;
      }
    } catch (err) {
      console.error('Writing linked file failed:', err);
      // fall through to auto-download as last resort
    }

    // Last resort: auto-download an updated copy so you always have one file on disk
    saveAs(new Blob([wbout], { type:'application/octet-stream' }), 'image-accountant-entries.xlsx');
  }

  // ---- Wire up the button (keep your existing event listener if present)
  document.getElementById('connectFileBtn').addEventListener('click', connectLocalFile);

  // ---- Call once on load to reflect current state
  setLinkStatus();
</script>
