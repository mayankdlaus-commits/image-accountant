<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Image Accountant</title>
  <style>
    :root { --bg:#f8f9fa; --fg:#212529; --muted:#6c757d; --border:#dee2e6; --card:#fff; --brand:#007bff; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 2rem; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    h1 { text-align: center; margin: 0 0 1.5rem; }
    .container { max-width: 900px; margin: 0 auto; background: var(--card); padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    .actions { display: flex; gap: .75rem; flex-wrap: wrap; align-items: center; margin-bottom: 1rem; }
    .hint { color: var(--muted); font-size: .9rem; }
    input[type="file"] { display: inline-block; }
    .grid { display: grid; grid-template-columns: 140px 1fr; gap: .5rem .75rem; margin-top: 1rem; }
    label { align-self: center; text-align: right; color: #444; }
    input, select { padding: .5rem .6rem; border: 1px solid var(--border); border-radius: 8px; }
    button { appearance: none; border: 0; padding: .55rem .9rem; border-radius: 8px; background: var(--brand); color: #fff; cursor: pointer; font-weight: 600; }
    button.secondary { background: #495057; }
    button.ghost { background: #e9ecef; color: #111; }
    button:disabled { background: var(--muted); cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: .6rem .5rem; border: 1px solid var(--border); text-align: left; }
    th { background: #eef2f7; }
    .footer-note { margin-top: .75rem; color: var(--muted); font-size: .9rem; }
    .ok { color: #2f8f46; font-weight: 600; }
    .warn { color: #b35b00; font-weight: 600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Image Accountant</h1>

    <div class="actions">
      <input type="file" id="fileInput" accept="image/*" />
      <button id="saveBtn" disabled>Save Entry</button>
      <button id="exportBtn" class="secondary">Export to Excel</button>
      <button id="connectFileBtn" class="ghost">Link Local File</button>
      <span id="linkStatus" class="hint">No linked file</span>
    </div>

    <div class="grid">
      <label for="vendorInput">Vendor</label>
      <input id="vendorInput" type="text" placeholder="e.g., 7-Eleven, Officeworks"/>

      <label for="dateInput">Date</label>
      <input id="dateInput" type="date"/>

      <label for="amountInput">Amount</label>
      <input id="amountInput" type="number" step="0.01" inputmode="decimal" placeholder="0.00"/>

      <label for="taxInput">Tax</label>
      <input id="taxInput" type="number" step="0.01" inputmode="decimal" placeholder="auto (10%) if empty"/>

      <label for="categoryInput">Category</label>
      <select id="categoryInput">
        <option>General</option><option>Travel</option><option>Meals</option>
        <option>Supplies</option><option>Fuel</option><option>Maintenance</option>
      </select>
    </div>

    <table id="entriesTable">
      <thead>
        <tr>
          <th>Date</th><th>Vendor</th><th>Category</th><th>Amount</th><th>Tax</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="footer-note">
      OCR runs fully in your browser. Linked local file works in Chromium browsers (Chrome/Edge). If the link is lost after a restart, just click <em>Link Local File</em> again.
    </div>
  </div>

  <!-- OCR -->
  <script src="https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <!-- Excel build -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.7/dist/xlsx.full.min.js"></script>
  <!-- Download fallback -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script>
    // --- Elements
    const fileInput       = document.getElementById('fileInput');
    const vendorInput     = document.getElementById('vendorInput');
    const dateInput       = document.getElementById('dateInput');
    const amountInput     = document.getElementById('amountInput');
    const taxInput        = document.getElementById('taxInput');
    const categoryInput   = document.getElementById('categoryInput');
    const saveBtn         = document.getElementById('saveBtn');
    const exportBtn       = document.getElementById('exportBtn');
    const connectFileBtn  = document.getElementById('connectFileBtn');
    const linkStatus      = document.getElementById('linkStatus');
    const tbody           = document.querySelector('#entriesTable tbody');

    // --- Data
    let entries = [];
    let fileHandle = null; // File System Access API handle (session only)

    // --- Save button state from manual inputs
    function updateSaveButton() {
      const ok = vendorInput.value.trim() && dateInput.value && amountInput.value;
      saveBtn.disabled = !ok;
    }
    [vendorInput, dateInput, amountInput].forEach(el => el.addEventListener('input', updateSaveButton));

    // --- Storage helpers (localStorage for persistence)
    function loadEntries() {
      const raw = localStorage.getItem('image_accountant_entries');
      if (raw) {
        try { entries = JSON.parse(raw) || []; } catch { entries = []; }
      }
      renderEntries();
    }
    function saveEntries() {
      localStorage.setItem('image_accountant_entries', JSON.stringify(entries));
    }

    // --- Table render
    function renderEntries() {
      tbody.innerHTML = '';
      for (const e of entries) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.date || ''}</td>
          <td>${e.vendor || ''}</td>
          <td>${e.category || ''}</td>
          <td>${e.amount != null ? Number(e.amount).toFixed(2) : ''}</td>
          <td>${e.tax != null ? Number(e.tax).toFixed(2) : ''}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // --- Naive OCR parsing
    function parseReceipt(text) {
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

      // Vendor: first non-numeric looking line
      let vendor = '';
      for (const line of lines) {
        if (/[A-Za-z]/.test(line) && !/^\d+([.,]\d+)*$/.test(line)) { vendor = line; break; }
      }

      // Date: try common patterns
      const datePatterns = [
        /(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/,      // yyyy-mm-dd
        /(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})/,    // dd/mm/yyyy or mm/dd/yyyy
      ];
      let dateISO = '';
      outer: for (const rx of datePatterns) {
        for (const line of lines) {
          const m = line.match(rx);
          if (m) {
            if (m[1].length === 4) {
              // yyyy, mm, dd
              const y = m[1], mm = m[2].padStart(2,'0'), dd = m[3].padStart(2,'0');
              dateISO = `${y}-${mm}-${dd}`; break outer;
            } else {
              // dd/mm/yyyy or mm/dd/yyyy -> guess
              let d = parseInt(m[1],10), mo = parseInt(m[2],10), y = m[3];
              if (String(y).length === 2) y = '20'+y;
              if (mo > 12) [d, mo] = [mo, d];
              dateISO = `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`; break outer;
            }
          }
        }
      }

      // Amounts
      const numRx = /\d+\.\d{2}/g;
      const nums = [];
      for (const line of lines) {
        const m = line.match(numRx);
        if (m) nums.push(...m.map(Number));
      }
      nums.sort((a,b)=>a-b);
      const amount = nums.length ? nums[nums.length-1] : null;

      // Tax (look for GST/TAX line, else assume 10%)
      let tax = null;
      for (const line of lines) {
        if (/\b(gst|tax|vat)\b/i.test(line)) {
          const m = line.match(numRx);
          if (m && m.length) { tax = Number(m[m.length-1]); break; }
        }
      }
      if (tax == null && amount != null) tax = Number((amount * 0.1).toFixed(2));

      return { vendor, dateISO, amount, tax };
    }

    // --- OCR via Tesseract on file change
    fileInput.addEventListener('change', async () => {
      const file = fileInput.files?.[0];
      if (!file) return;
      saveBtn.disabled = true;

      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const result = await Tesseract.recognize(reader.result, 'eng');
          const text = result.data.text || '';
          const { vendor, dateISO, amount, tax } = parseReceipt(text);

          if (vendor) vendorInput.value = vendor;
          if (dateISO) dateInput.value = dateISO;
          if (amount != null) amountInput.value = amount;
          if (tax != null) taxInput.value = tax;

          updateSaveButton();
        } catch (err) {
          console.error(err);
          alert('OCR failed. You can still fill fields manually.');
        }
      };
      reader.readAsDataURL(file);
    });

    // --- File System Access API helpers (Chrome/Edge)
    const fsSupported = 'showSaveFilePicker' in window;
    function setLinkStatus() {
      if (!fsSupported) {
        linkStatus.innerHTML = 'Local file linking not supported in this browser';
        linkStatus.className = 'hint warn';
        connectFileBtn.style.display = 'none';
        return;
      }
      if (fileHandle) {
        linkStatus.innerHTML = 'Linked âœ”';
        linkStatus.className = 'hint ok';
      } else {
        linkStatus.innerHTML = 'No linked file';
        linkStatus.className = 'hint';
      }
    }
    setLinkStatus();

    async function connectLocalFile() {
      if (!fsSupported) { alert('Your browser does not support this feature. Use Chrome/Edge.'); return; }
      try {
        fileHandle = await window.showSaveFilePicker({
          suggestedName: 'image-accountant-entries.xlsx',
          types: [{
            description: 'Excel',
            accept: {
              'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
            },
          }],
        });
        await updateLinkedFile(); // write current entries immediately
        setLinkStatus();
        alert('Local file linked. New entries will update this file.');
      } catch (err) {
        if (err && err.name === 'AbortError') return; // user canceled
        console.error(err);
        alert('Could not link file.');
      }
    }

    async function updateLinkedFile() {
      if (!fileHandle) return;
      // Build workbook from entries
      const wsData = [
        ['Date','Vendor','Category','Amount','Tax'],
        ...entries.map(e => [e.date, e.vendor, e.category, e.amount, e.tax]),
      ];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Receipts');
      const wbout = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });

      const writable = await fileHandle.createWritable();
      await writable.write(wbout);
      await writable.close();
    }

    connectFileBtn.addEventListener('click', connectLocalFile);

    // --- Save one entry
    saveBtn.addEventListener('click', async () => {
      const entry = {
        vendor  : (vendorInput.value || '').trim(),
        date    : dateInput.value || '',
        amount  : amountInput.value ? Number(amountInput.value) : null,
        tax     : taxInput.value ? Number(taxInput.value) : null,
        category: categoryInput.value || 'General',
      };
      entries.push(entry);
      saveEntries();
      renderEntries();

      // Reset form
      vendorInput.value = '';
      dateInput.value = '';
      amountInput.value = '';
      taxInput.value = '';
      categoryInput.value = 'General';
      fileInput.value = '';
      updateSaveButton();

      // If linked to a local file, update it too
      try { await updateLinkedFile(); } catch (e) { console.error(e); alert('Could not update linked file.'); }
    });

    // --- Export (download) as Excel (fallback when not linking a file)
    exportBtn.addEventListener('click', () => {
      if (!entries.length) { alert('No entries to export.'); return; }
      const wsData = [
        ['Date','Vendor','Category','Amount','Tax'],
        ...entries.map(e => [e.date, e.vendor, e.category, e.amount, e.tax]),
      ];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Receipts');
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      saveAs(new Blob([wbout], { type: 'application/octet-stream' }), 'image-accountant-entries.xlsx');
    });

    // --- Init
    loadEntries();
    updateSaveButton();
  </script>
</body>
</html>
