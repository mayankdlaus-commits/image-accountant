<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Image Accountant</title>
  <style>
    :root { --bg:#f8f9fa; --fg:#212529; --muted:#6c757d; --border:#dee2e6; --card:#fff; --brand:#007bff;}
    *{box-sizing:border-box}
    body{margin:0;padding:2rem;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    h1{margin:0 0 1.25rem;text-align:center}
    .container{max-width:960px;margin:0 auto;background:var(--card);padding:1.25rem;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .row{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center}
    .actions{margin:.5rem 0 1rem}
    .hint{color:var(--muted);font-size:.9rem}
    .grid{display:grid;grid-template-columns:140px 1fr;gap:.5rem .75rem;margin-top:1rem}
    label{align-self:center;text-align:right;color:#444}
    input,select{padding:.5rem .6rem;border:1px solid var(--border);border-radius:8px; width: 100%;}
    button{appearance:none;border:0;padding:.55rem .9rem;border-radius:8px;background:var(--brand);color:#fff;cursor:pointer;font-weight:600}
    button.secondary{background:#495057}
    button.ghost{background:#e9ecef;color:#111}
    button:disabled{background:var(--muted);cursor:not-allowed}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:.6rem .5rem;border:1px solid var(--border);text-align:left}
    th{background:#eef2f7}
    .ok{color:#2f8f46;font-weight:600}.warn{color:#b35b00;font-weight:600}.bad{color:#b00020;font-weight:600}
    .preview{max-height:240px;max-width:100%;object-fit:contain;border:1px dashed var(--border);border-radius:10px;padding:6px;background:#fff}
    progress{width:220px;height:10px;border-radius:6px}
    .col{display:flex;flex-direction:column;gap:.35rem}
    .split { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .switch { display:inline-flex; align-items:center; gap:8px; }
    /* Responsive adjustments */
    @media (max-width: 768px) {
      body { padding: 1rem; }
      .grid { grid-template-columns: 100px 1fr; }
      label { text-align: left; }
    }
    @media (max-width: 480px) {
        h1 { font-size: 1.5rem; }
        .grid { grid-template-columns: 1fr; }
        label { text-align: left; margin-bottom: -0.25rem; }
        .actions { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Image Accountant</h1>

    <div class="row actions">
      <input type="file" id="fileInput" accept="image/*"/>
      <img id="preview" class="preview" alt="Image preview will appear here"/>
      <div class="col">
        <progress id="ocrProgress" max="1" value="0" style="display:none"></progress>
        <span id="ocrStatus" class="hint"></span>
      </div>
    </div>

    <div class="row actions split">
      <button id="saveBtn" disabled>Save Entry</button>
      <button id="exportBtn" class="secondary">Export to Excel</button>
      <button id="exportPdfBtn" class="secondary">Export to PDF</button>
      <button id="connectFileBtn" class="ghost">Link Local File</button>
      <span id="linkStatus" class="hint">No linked file</span>
      <span class="switch">
        <input type="checkbox" id="preprocessToggle" checked />
        <label for="preprocessToggle" class="hint">Preprocess Image</label>
      </span>
    </div>

    <div class="grid">
      <label for="vendorInput">Vendor</label>
      <input id="vendorInput" type="text" placeholder="e.g., Officeworks"/>

      <label for="dateInput">Date</label>
      <input id="dateInput" type="date"/>

      <label for="amountInput">Total</label>
      <input id="amountInput" type="number" step="0.01" inputmode="decimal" placeholder="0.00"/>

      <label for="taxInput">Tax</label>
      <input id="taxInput" type="number" step="0.01" inputmode="decimal" placeholder="auto (10%) if empty"/>

      <label for="categoryInput">Category</label>
      <select id="categoryInput">
        <option>General</option><option>Travel</option><option>Meals</option>
        <option>Supplies</option><option>Fuel</option><option>Maintenance</option>
      </select>
    </div>

    <div style="overflow-x:auto; margin-top: 1rem;">
        <table id="entriesTable">
          <thead><tr><th>Date</th><th>Vendor</th><th>Category</th><th>Total</th><th>Tax</th></tr></thead>
          <tbody></tbody>
        </table>
    </div>


    <p class="hint" style="margin-top:.75rem">
      OCR powered by API Ninjas.
    </p>
  </div>

  <!-- Third-party libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.7/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <script>
    // ====== CONFIGURATION ======
    const API_NINJAS_KEY = '700xsqwrVIAUQMwb+YiO7Q==7xLpeBxKrShSutel';
    const API_URL = 'https://api.api-ninjas.com/v1/imagetotext';

    // ====== DOM ELEMENT REFERENCES ======
    const fileInput       = document.getElementById('fileInput');
    const preview         = document.getElementById('preview');
    const ocrProgress     = document.getElementById('ocrProgress');
    const ocrStatus       = document.getElementById('ocrStatus');
    const preprocessToggle= document.getElementById('preprocessToggle');
    const vendorInput     = document.getElementById('vendorInput');
    const dateInput       = document.getElementById('dateInput');
    const amountInput     = document.getElementById('amountInput');
    const taxInput        = document.getElementById('taxInput');
    const categoryInput   = document.getElementById('categoryInput');
    const saveBtn         = document.getElementById('saveBtn');
    const exportBtn       = document.getElementById('exportBtn');
    const exportPdfBtn    = document.getElementById('exportPdfBtn');
    const connectFileBtn  = document.getElementById('connectFileBtn');
    const linkStatus      = document.getElementById('linkStatus');
    const tbody           = document.querySelector('#entriesTable tbody');

    // ====== APPLICATION STATE ======
    let entries = [];
    let fileHandle = null;
    let opfsFileHandle = null;
    let useOPFS = JSON.parse(localStorage.getItem('ia_use_opfs') || 'false');

    // ====== UI HELPER FUNCTIONS ======
    function updateSaveButtonState() {
      saveBtn.disabled = !(vendorInput.value.trim() && dateInput.value && amountInput.value);
    }

    function loadEntriesFromStorage() {
      const raw = localStorage.getItem('image_accountant_entries');
      if (raw) { try { entries = JSON.parse(raw) || []; } catch { entries = []; } }
      renderEntriesTable();
    }

    function saveEntriesToStorage() {
      localStorage.setItem('image_accountant_entries', JSON.stringify(entries));
    }

    function renderEntriesTable() {
      tbody.innerHTML = '';
      for (const e of entries) {
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${e.date || ''}</td>
           <td>${e.vendor || ''}</td>
           <td>${e.category || ''}</td>
           <td style="text-align:right;">${e.amount != null ? Number(e.amount).toFixed(2) : ''}</td>
           <td style="text-align:right;">${e.tax != null ? Number(e.tax).toFixed(2) : ''}</td>`;
        tbody.appendChild(tr);
      }
    }

    // ====== IMAGE PREPROCESSING ======
    async function preprocessImage(imgFile) {
      const imgURL = URL.createObjectURL(imgFile);
      try {
        const img = await new Promise((res, rej) => {
          const im = new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=imgURL;
        });

        const MAX_SIDE = 2200;
        const scale = Math.min(MAX_SIDE / Math.max(img.naturalWidth, img.naturalHeight), 3);
        const cw = Math.round(img.naturalWidth * Math.max(1, scale));
        const ch = Math.round(img.naturalHeight * Math.max(1, scale));

        const canvas = document.createElement('canvas');
        canvas.width = cw;
        canvas.height = ch;
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, 0, 0, cw, ch);

        // Grayscale and contrast stretch for better clarity
        const imgData = ctx.getImageData(0, 0, cw, ch);
        const d = imgData.data;
        let min = 255, max = 0;
        for (let i = 0; i < d.length; i += 4) {
          const gray = d[i] * 0.299 + d[i+1] * 0.587 + d[i+2] * 0.114;
          if (gray < min) min = gray;
          if (gray > max) max = gray;
        }
        const spread = Math.max(1, max - min);
        for (let i = 0; i < d.length; i += 4) {
          let gray = d[i] * 0.299 + d[i+1] * 0.587 + d[i+2] * 0.114;
          gray = (gray - min) * (255 / spread);
          const v = gray | 0;
          d[i] = d[i+1] = d[i+2] = v;
        }
        ctx.putImageData(imgData, 0, 0);

        // *** FIX: Increased JPEG compression to further reduce file size ***
        return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.75));
      } finally {
        URL.revokeObjectURL(imgURL);
      }
    }

    // ====== OCR API CALL ======
    async function performOcr(fileOrBlob) {
      if (!API_NINJAS_KEY || API_NINJAS_KEY === 'YOUR_API_KEY_HERE') {
        throw new Error('Missing API key. Please edit the script and set API_NINJAS_KEY.');
      }
      const formData = new FormData();
      formData.append('image', fileOrBlob, 'input.jpg'); // Sending as JPG

      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'X-Api-Key': API_NINJAS_KEY },
        body: formData
      });

      if (!response.ok) {
        if (response.status === 401) throw new Error('Unauthorized (check your API key).');
        if (response.status === 413) throw new Error('Image too large for your API plan.');
        const errorText = await response.text().catch(() => 'Request failed');
        throw new Error(`OCR error ${response.status}: ${errorText}`);
      }
      const data = await response.json();
      return Array.isArray(data) ? data.map(o => o.text || '').join('\n') : '';
    }

    // ====== OCR TEXT PARSING LOGIC ======
    function parseOcrText(fullText) {
        const text = (fullText || '').replace(/[^\S\r\n]+/g, ' ').trim();
        const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

        // --- 1. Vendor Extraction ---
        let vendor = '';
        const nonVendorWords = /invoice|receipt|tax|inc|ltd|cash|sale|abn/i;
        let bestVendorCandidate = '';
        for (const line of lines.slice(0, 5)) {
            if (line.length > 2 && line === line.toUpperCase() && !/\d/.test(line) && !nonVendorWords.test(line)) {
                vendor = line;
                break;
            }
            if (!bestVendorCandidate && /[a-z]/i.test(line) && !/^\$?[\d.,]/.test(line) && !nonVendorWords.test(line)) {
                bestVendorCandidate = line;
            }
        }
        if (!vendor) vendor = bestVendorCandidate;
        vendor = vendor.replace(/\s{2,}.*/, '').trim();

        // --- 2. Date Extraction ---
        const dateRegexes = [
            /\b(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})\b/, // YYYY-MM-DD
            /\b(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})\b/, // DD/MM/YYYY
            /\b(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*[ ,.-]+(\d{4})\b/i, // 18 Aug 2024
            /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+(\d{1,2}),?\s+(\d{4})\b/i // Aug 18, 2024
        ];
        const monthMap = {jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
        let dateISO = '';
        outerDate: for (const rx of dateRegexes) {
            for (const line of lines) {
                const m = line.match(rx);
                if (!m) continue;
                if (rx === dateRegexes[0]) { dateISO = `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}`; break outerDate; }
                if (rx === dateRegexes[1]) { let d=m[1], mo=m[2], y=m[3]; if (y.length === 2) y = '20' + y; if (parseInt(mo,10) > 12) [d,mo]=[mo,d]; dateISO = `${y}-${mo.padStart(2, '0')}-${d.padStart(2, '0')}`; break outerDate; }
                if (rx === dateRegexes[2]) { const mm = monthMap[m[2].slice(0,3).toLowerCase()]; dateISO = `${m[3]}-${String(mm).padStart(2, '0')}-${m[1].padStart(2, '0')}`; break outerDate; }
                if (rx === dateRegexes[3]) { const mm = monthMap[m[1].slice(0,3).toLowerCase()]; dateISO = `${m[3]}-${String(mm).padStart(2, '0')}-${m[2].padStart(2, '0')}`; break outerDate; }
            }
        }

        // --- 3. Total and Tax Extraction ---
        const moneyRx = /(?:[\$£€]\s*)?(\d{1,3}(?:,?\d{3})*(?:\.\d{2}))/g;
        let amount = null;
        let tax = null;

        for (let i = lines.length - 1; i >= 0; i--) {
            const line = lines[i].toLowerCase();
            const matches = [...line.matchAll(moneyRx)];
            if (!matches.length) continue;

            const value = parseFloat(matches[matches.length - 1][1].replace(/,/g, ''));

            if (amount === null && (line.includes('total') || line.includes('debit')) && !line.includes('sub') && !line.includes('item')) {
                amount = value;
            }
            if (tax === null && /\b(tax|gst|vat)\b/.test(line)) {
                tax = value;
            }
            if (amount !== null && tax !== null) break;
        }
        
        if (amount === null) {
            const nums = [];
            for (const line of lines.slice(Math.floor(lines.length / 2))) {
                const matches = line.match(moneyRx);
                if (matches) nums.push(...matches.map(s => parseFloat(s.replace(/[^\d.]/g, ''))));
            }
            if (nums.length) amount = Math.max(...nums);
        }

        if (tax === null && amount !== null) {
            tax = Number((amount / 11).toFixed(2)); // Common calculation for GST included price
        }

        return { vendor, dateISO, amount, tax };
    }

    // ====== EVENT HANDLERS ======
    async function handleFileChange() {
      const file = fileInput.files?.[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.style.display = 'block';

      try {
        ocrProgress.style.display = 'block';
        ocrProgress.value = 0;
        ocrStatus.textContent = 'Processing image...';
        ocrStatus.className = 'hint';

        const imageToSend = preprocessToggle.checked ? await preprocessImage(file) : file;
        ocrStatus.textContent = 'Performing OCR...';
        const text = await performOcr(imageToSend);

        ocrStatus.textContent = 'Parsing results...';
        const { vendor, dateISO, amount, tax } = parseOcrText(text);
        if (vendor) vendorInput.value = vendor;
        if (dateISO) dateInput.value = dateISO;
        if (amount != null) amountInput.value = amount;
        if (tax != null) taxInput.value = tax;

        updateSaveButtonState();
        ocrStatus.textContent = 'OCR complete.';
      } catch (e) {
        console.error(e);
        ocrStatus.textContent = `Error: ${e.message}`;
        ocrStatus.className = 'hint bad';
      } finally {
        ocrProgress.style.display = 'none';
        URL.revokeObjectURL(url);
      }
    }

    function handleSaveEntry() {
      const entry = {
        vendor: (vendorInput.value || '').trim(),
        date: dateInput.value || '',
        amount: amountInput.value ? Number(amountInput.value) : null,
        tax: taxInput.value ? Number(taxInput.value) : null,
        category: categoryInput.value || 'General'
      };
      entries.push(entry);
      saveEntriesToStorage();
      renderEntriesTable();

      // Reset form fields
      vendorInput.value = '';
      dateInput.value = '';
      amountInput.value = '';
      taxInput.value = '';
      categoryInput.value = 'General';
      fileInput.value = '';
      preview.src = '';
      preview.style.display = 'none';
      ocrStatus.textContent = '';
      updateSaveButtonState();
    }

    function handleExportXLSX() {
        if (!entries.length) return;
        const wsData = [['Date', 'Vendor', 'Category', 'Amount', 'Tax'],
            ...entries.map(e => [e.date, e.vendor, e.category, e.amount, e.tax])];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(wsData), 'Receipts');
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        saveAs(new Blob([wbout], { type: 'application/octet-stream' }), 'receipts.xlsx');
    }

    function handleExportPDF() {
        if (!entries.length) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });

        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.text('Receipts Summary', 40, 40);

        const body = entries.map(e => [
            e.date || '', e.vendor || '', e.category || '',
            e.amount != null ? Number(e.amount).toFixed(2) : '',
            e.tax != null ? Number(e.tax).toFixed(2) : ''
        ]);
        const totalAmount = entries.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
        const totalTax = entries.reduce((sum, e) => sum + (Number(e.tax) || 0), 0);

        doc.autoTable({
            startY: 60,
            head: [['Date', 'Vendor', 'Category', 'Total', 'Tax']],
            body: body,
            theme: 'grid',
            headStyles: { fillColor: [22, 160, 133], textColor: 255 },
            columnStyles: { 3: { halign: 'right' }, 4: { halign: 'right' } }
        });

        const finalY = doc.lastAutoTable.finalY + 20;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        doc.text(`Total Amount: ${totalAmount.toFixed(2)}`, 40, finalY);
        doc.text(`Total Tax: ${totalTax.toFixed(2)}`, 40, finalY + 16);

        doc.save('receipts-summary.pdf');
    }

    // ====== INITIALIZATION ======
    function initialize() {
      // Attach event listeners
      fileInput.addEventListener('change', handleFileChange);
      saveBtn.addEventListener('click', handleSaveEntry);
      exportBtn.addEventListener('click', handleExportXLSX);
      exportPdfBtn.addEventListener('click', handleExportPDF);
      [vendorInput, dateInput, amountInput].forEach(el => el.addEventListener('input', updateSaveButtonState));

      // Load initial data
      loadEntriesFromStorage();
      updateSaveButtonState();
    }

    // Run the app
    initialize();

  </script>
</body>
</html>
